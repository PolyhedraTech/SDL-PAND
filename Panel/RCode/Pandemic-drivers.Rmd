---
title: "Drivers of the SARS-CoV-2 in Catalonia"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: scroll
---

```{r setup, include=FALSE}

library(flexdashboard)
library("knitr")
library("RSocrata")
library(plotly)
library(personograph)
library(dplyr)
library(TSdist)
library(lmtest)
library(vars)
library(urca)
library(htmlwidgets)
library(downloadthis)
library(writexl)
library(tseries)

knitr::opts_chunk$set(echo = TRUE)

min_n_dies <- function(n,serie_dades, position)
{
  solution <- NULL
  longitud <- length(serie_dades)
  
  if(position+n>longitud)
  {
      subset_serie <- serie_dades[as.numeric(longitud-n):as.numeric(longitud)]
  }else
  {
    subset_serie <- serie_dades[as.numeric(position):as.numeric(position+n)]    
  }

  solution <- min(subset_serie)
  
  return(solution)
}

max_n_dies <- function(n, serie_dades, position)
{
  solution <- NULL
  longitud <- length(serie_dades)
  
  if(position+n>longitud)
  {
      subset_serie <- serie_dades[as.numeric(longitud-n):as.numeric(longitud)]
  }else
  {
    subset_serie <- serie_dades[as.numeric(position):as.numeric(position+n)]    
  }

  solution <- max(subset_serie)

  return(solution)
}


```

The question {data-icon="fa-list"}
===============================================================

Row
-------------------------------------

### The question

What are the drivers of the SARC-CoV-2 spread on Catalonia?


```{r cars, include=FALSE, echo=FALSE}


update=TRUE


if(update){

  # https://analisi.transparenciacatalunya.cat/en/Salut/Registre-de-casos-de-COVID-19-realitzats-a-Catalun/qwj8-xpvk
  casosTotal <- read.socrata("https://analisi.transparenciacatalunya.cat/api/odata/v4/qwj8-xpvk")
  
  casosPositius <- casosTotal %>% filter(resultatcoviddescripcio != 'Sospitós')
  casosPositiusData <- aggregate(casosPositius$numcasos, by=list(casosPositius$data), sum)
  casosPositiusData$Group.1 <- as.Date(casosPositiusData$Group.1, format = "%y/%m/%d")
  
  #casosPositiusAll <- aggregate(casosPositius$numcasos, by=list(casosPositius$data), sum)
  #casosPositiusAll$Group.1 <- as.Date(casosPositiusAll$Group.1 , format = "%y/%m/%d")
  
  casosPositiusMenors <- casosPositius %>% filter(edatrang == '0-9')
  casosPositiusSub9 <- aggregate(casosPositiusMenors$numcasos, by=list(casosPositiusMenors$data), sum)
  casosPositiusSub9$Group.1 <- as.Date(casosPositiusSub9$Group.1 , format = "%y/%m/%d")
  
  
  casosPositiusMenorsB <- casosPositius %>% filter(edatrang == '10-19')
  casosPositiusSub19 <- aggregate(casosPositiusMenorsB$numcasos, by=list(casosPositiusMenorsB$data), sum)
  casosPositiusSub19$Group.1 <- as.Date(casosPositiusSub19$Group.1 , format = "%y/%m/%d")
  
  
  casosPositiusJoves <- casosPositius %>% filter(edatrang == '20-29')
  casosPositiusSub29 <- aggregate(casosPositiusJoves$numcasos, by=list(casosPositiusJoves$data), sum)
  casosPositiusSub29$Group.1 <- as.Date(casosPositiusSub29$Group.1 , format = "%y/%m/%d")
  
  
  casosPositiusAduls39 <- casosPositius %>% filter(edatrang == '30-39')
  casosPositiusSub39 <- aggregate(casosPositiusAduls39$numcasos, by=list(casosPositiusAduls39$data), sum)
  casosPositiusSub39$Group.1 <- as.Date(casosPositiusSub39$Group.1 , format = "%y/%m/%d")
  
  
  casosPositiusAduls49 <- casosPositius %>% filter(edatrang == '40-49')
  casosPositiusSub49 <- aggregate(casosPositiusAduls49$numcasos, by=list(casosPositiusAduls49$data), sum)
  casosPositiusSub49$Group.1 <- as.Date(casosPositiusSub49$Group.1 , format = "%y/%m/%d")
  
  
  casosPositiusAduls59 <- casosPositius %>% filter(edatrang == '50-59')
  casosPositiusSub59 <- aggregate(casosPositiusAduls59$numcasos, by=list(casosPositiusAduls59$data), sum)
  casosPositiusSub59$Group.1 <- as.Date(casosPositiusSub59$Group.1 , format = "%y/%m/%d")
  
  
  casosPositiusAduls69 <- casosPositius %>% filter(edatrang == '60-69')
  casosPositiusSub69 <- aggregate(casosPositiusAduls69$numcasos, by=list(casosPositiusAduls69$data), sum)
  casosPositiusSub69$Group.1 <- as.Date(casosPositiusSub69$Group.1 , format = "%y/%m/%d")
  
  
  casosPositiusAduls79 <- casosPositius %>% filter(edatrang == '70-79')
  casosPositiusSub79 <- aggregate(casosPositiusAduls79$numcasos, by=list(casosPositiusAduls79$data), sum)
  casosPositiusSub79$Group.1 <- as.Date(casosPositiusSub79$Group.1 , format = "%y/%m/%d")
  
  
  casosPositiusAduls89 <- casosPositius %>% filter(edatrang == '80-89')
  casosPositiusSub89 <- aggregate(casosPositiusAduls89$numcasos, by=list(casosPositiusAduls89$data), sum)
  casosPositiusSub89$Group.1 <- as.Date(casosPositiusSub89$Group.1 , format = "%y/%m/%d")
  
  
  casosPositiusAduls90 <- casosPositius %>% filter(edatrang == '90+')
  casosPositiusSub90 <- aggregate(casosPositiusAduls90$numcasos, by=list(casosPositiusAduls90$data), sum)
  casosPositiusSub90$Group.1 <- as.Date(casosPositiusSub90$Group.1 , format = "%y/%m/%d")
  
  
  centresDocents <- read.socrata("https://analisi.transparenciacatalunya.cat/api/odata/v4/3u9c-b74b")
  casosEscoles <- read.socrata("https://analisi.transparenciacatalunya.cat/api/odata/v4/fk8v-uqfv")
  
  PCRs <- read.socrata("https://analisi.transparenciacatalunya.cat/api/odata/v4/dmzh-fz47")
  
  PCRsAll <- aggregate(PCRs$pcr, by=list(PCRs$data), sum)
  PCRsAll$Group.1 <- as.Date(PCRsAll$Group.1 , format = "%y/%m/%d")
  
  # Han canviat els rangs d'edat de nou...
  
  PCRsSub09 <- PCRs %>% filter(grup_edat == '0 a 9')
  PCRsSub09 <- aggregate(PCRsSub09$pcr, by=list(PCRsSub09$data), sum)
  PCRsSub09$Group.1 <- as.Date(PCRsSub09$Group.1 , format = "%y/%m/%d")
  write.csv(PCRsSub09, "PCRsSub09.csv")
  
  PCRsSub19 <- PCRs %>% filter(grup_edat == '10 a 19')
  PCRsSub19 <- aggregate(PCRsSub19$pcr, by=list(PCRsSub19$data), sum)
  PCRsSub19$Group.1 <- as.Date(PCRsSub19$Group.1 , format = "%y/%m/%d")
  write.csv(PCRsSub19, "PCRsSub19.csv")
  
  PCRsSub29 <- PCRs %>% filter(grup_edat == '20 a 29')
  PCRsSub29 <- aggregate(PCRsSub29$pcr, by=list(PCRsSub29$data), sum)
  PCRsSub29$Group.1 <- as.Date(PCRsSub29$Group.1 , format = "%y/%m/%d")
  write.csv(PCRsSub29, "PCRsSub29.csv")
  
  PCRsSub39 <- PCRs %>% filter(grup_edat == '30 a 39')
  PCRsSub39 <- aggregate(PCRsSub39$pcr, by=list(PCRsSub39$data), sum)
  PCRsSub39$Group.1 <- as.Date(PCRsSub39$Group.1 , format = "%y/%m/%d")
  write.csv(PCRsSub39, "PCRsSub39.csv")
  
  PCRsSub49 <- PCRs %>% filter(grup_edat == '40 a 49')
  PCRsSub49 <- aggregate(PCRsSub49$pcr, by=list(PCRsSub49$data), sum)
  PCRsSub49$Group.1 <- as.Date(PCRsSub49$Group.1 , format = "%y/%m/%d")
  write.csv(PCRsSub49, "PCRsSub49.csv")
  
  PCRsSub59 <- PCRs %>% filter(grup_edat == '50 a 59')
  PCRsSub59 <- aggregate(PCRsSub59$pcr, by=list(PCRsSub59$data), sum)
  PCRsSub59$Group.1 <- as.Date(PCRsSub59$Group.1 , format = "%y/%m/%d")
  write.csv(PCRsSub59, "PCRsSub59.csv")
  
  PCRsSub69 <- PCRs %>% filter(grup_edat == '60 a 69')
  PCRsSub69 <- aggregate(PCRsSub69$pcr, by=list(PCRsSub69$data), sum)
  PCRsSub69$Group.1 <- as.Date(PCRsSub69$Group.1 , format = "%y/%m/%d")
  write.csv(PCRsSub69, "PCRsSub69.csv")
  
  PCRsSub79 <- PCRs %>% filter(grup_edat == '70 a 79')
  PCRsSub79 <- aggregate(PCRsSub79$pcr, by=list(PCRsSub79$data), sum)
  PCRsSub79$Group.1 <- as.Date(PCRsSub79$Group.1 , format = "%y/%m/%d")
  write.csv(PCRsSub79, "PCRsSub79.csv")

  PCRsSub89 <- PCRs %>% filter(grup_edat == '80 o més')
  PCRsSub89 <- aggregate(PCRsSub89$pcr, by=list(PCRsSub89$data), sum)
  PCRsSub89$Group.1 <- as.Date(PCRsSub89$Group.1 , format = "%y/%m/%d")
  write.csv(PCRsSub89, "PCRsSub89.csv")
    

  #Crear una matriu de dades amb tota la informació i imputant valors de 0 a les dades mancants.
  
  
  AllData <- merge(casosPositiusData, PCRsAll, by="Group.1", all.x=TRUE, all.y=TRUE)
  AllData <- merge(AllData, casosPositiusSub9, by="Group.1", all.x=TRUE)
  
  AllData <- merge(AllData, casosPositiusSub19, by="Group.1", all.x=TRUE)
  AllData <- merge(AllData, casosPositiusSub29, by="Group.1", all.x=TRUE)
  AllData <- merge(AllData, casosPositiusSub39, by="Group.1", all.x=TRUE)
  AllData <- merge(AllData, casosPositiusSub49, by="Group.1", all.x=TRUE)
  AllData <- merge(AllData, casosPositiusSub59, by="Group.1", all.x=TRUE)
  AllData <- merge(AllData, casosPositiusSub69, by="Group.1", all.x=TRUE)
  AllData <- merge(AllData, casosPositiusSub79, by="Group.1", all.x=TRUE)
  AllData <- merge(AllData, casosPositiusSub89, by="Group.1", all.x=TRUE)
  AllData <- merge(AllData, casosPositiusSub90, by="Group.1", all.x=TRUE)
  
  AllData <- merge(AllData, PCRsSub09, by="Group.1", all.x=TRUE)
  AllData <- merge(AllData, PCRsSub19, by="Group.1", all.x=TRUE)
  AllData <- merge(AllData, PCRsSub29, by="Group.1", all.x=TRUE)
  AllData <- merge(AllData, PCRsSub39, by="Group.1", all.x=TRUE)
  AllData <- merge(AllData, PCRsSub49, by="Group.1", all.x=TRUE)
  AllData <- merge(AllData, PCRsSub59, by="Group.1", all.x=TRUE)
  AllData <- merge(AllData, PCRsSub69, by="Group.1", all.x=TRUE)
  AllData <- merge(AllData, PCRsSub79, by="Group.1", all.x=TRUE)
  AllData <- merge(AllData, PCRsSub89, by="Group.1", all.x=TRUE)
  

  colnames(AllData) <- c("Data", "casosPositiusData", "PCRsData", "Sub9", "Sub19", "Sub29", "Sub39", "Sub49",
        "Sub59","Sub69","Sub79","Sub89","Sub90", "PCRsSub09", "PCRsSub19", "PCRsSub29",
        "PCRsSub39","PCRsSub49", "PCRsSub59","PCRsSub69","PCRsSub79", "PCRsSub89")
  
  #Replace NAs by zeros.
  AllData[is.na(AllData)] <- 0
}

############ PREVLENCE ANLYSIS

#Taula assimptomatologia
assimp<-c(0.8,0.7,0.5,0.4,0.4,0.4,0.5,0.7,0.8)
# "2020-10-16" Close the bars

EndRoundIII <- "2020-06-22"
EndRoundVI <- "2020-11-29"

PopulationCAT <- 7727029 #sum(PopEdats$pop)

EndRoundIIIIndex <- which(grepl(EndRoundIII, AllData$Data))
EndRoundIVIndex <- which(grepl(EndRoundVI, AllData$Data))


casesRoundIII=data.frame(
  AllCases=c(sum(AllData$casosPositiusData[1:EndRoundIIIIndex])),
  Sum09=c(sum(AllData$Sub9[1:EndRoundIIIIndex])),
  Sum19=c(sum(AllData$Sub19[1:EndRoundIIIIndex])),
  Sum29=c(sum(AllData$Sub29[1:EndRoundIIIIndex])),
  Sum39=c(sum(AllData$Sub39[1:EndRoundIIIIndex])),
  Sum49=c(sum(AllData$Sub49[1:EndRoundIIIIndex])),
  Sum59=c(sum(AllData$Sub59[1:EndRoundIIIIndex])),
  Sum69=c(sum(AllData$Sub69[1:EndRoundIIIIndex])),
  Sum79=c(sum(AllData$Sub79[1:EndRoundIIIIndex])),
  Sum89=c(sum(AllData$Sub89[1:EndRoundIIIIndex])),
  Sum90=c(sum(AllData$Sub90[1:EndRoundIIIIndex]))
)

casesRoundIV.III=data.frame(
  AllCases=c(sum(AllData$casosPositiusData[EndRoundIIIIndex:EndRoundIVIndex])),
  Sum09=c(sum(AllData$Sub9[EndRoundIIIIndex:EndRoundIVIndex])),
  Sum19=c(sum(AllData$Sub19[EndRoundIIIIndex:EndRoundIVIndex])),
  Sum29=c(sum(AllData$Sub29[EndRoundIIIIndex:EndRoundIVIndex])),
  Sum39=c(sum(AllData$Sub39[EndRoundIIIIndex:EndRoundIVIndex])),
  Sum49=c(sum(AllData$Sub49[EndRoundIIIIndex:EndRoundIVIndex])),
  Sum59=c(sum(AllData$Sub59[EndRoundIIIIndex:EndRoundIVIndex])),
  Sum69=c(sum(AllData$Sub69[EndRoundIIIIndex:EndRoundIVIndex])),
  Sum79=c(sum(AllData$Sub79[EndRoundIIIIndex:EndRoundIVIndex])),
  Sum89=c(sum(AllData$Sub89[EndRoundIIIIndex:EndRoundIVIndex])),
  Sum90=c(sum(AllData$Sub90[EndRoundIIIIndex:EndRoundIVIndex]))
)


prevalenceCAT<-data.frame(
  RoundI=5.8,
  RoundII=6.10,
  RoundIII=5.9,
  roundIV=11.6,
  RoundIV.III=5.7
)

  prevalenceCAT$RealCasesIII=PopulationCAT*prevalenceCAT$RoundIII/100
  prevalenceCAT$RealCasesVI.III=PopulationCAT*prevalenceCAT$RoundIV.III/100
  prevalenceCAT$DetectedCasesIII=casesRoundIII$AllCases
  prevalenceCAT$DetectedCasesIV.III=casesRoundIV.III$AllCases

  prevalenceCAT$percentDetIII=prevalenceCAT$DetectedCasesIII*100/prevalenceCAT$RealCasesIII
  prevalenceCAT$percentDetVI.III=prevalenceCAT$DetectedCasesIV.III*100/prevalenceCAT$RealCasesVI.III


  
#Població CAT per edats
PopEdats <- data.frame(
  edat=c("0-9","10-19","20-29","30-39","40-49","50-59","60-69","70-79","80-89","90+"),
  pop=c(746311,835030,837118,1015386,1296794,1083699,832391,633302,354547,92451),
  assimp=c(0.7,0.7,0.64,0.59,0.57,0.6,0.62,0.69,0.69,0.69),
  prevI=c(2.646675058,3.854530428,4.596409501,4.39835461,5.506558935,5.849695064,5.931542969,6.218123293,5.583319468,5.4),
  prevII=c(2.748696384,3.751459695,4.543399574,4.613727099,5.657162285,5.951383941,6.375037594,6.821122112,5.682189607,7.6),
  prevIII=c(3.073759647,3.811887901,4.734552999,4.530223986,5.605904196,5.949401725,6.212531792,6.52545754,5.583353293,7.7),
  prevIV=c(6.552843395,8.552333397,10.1,9.160160571,10.21419858,11.39770717,10.56828329,10.62208955,9.338741722,8.5),
  prevIv.III=c(3.479083747,4.740445496,5.365447001,4.629936585,4.608294381,5.448305448,4.355751503,4.096632012,3.755388428,0.8),
  #percentDetIV=c(56.05863315,69.96305861,65.26779917,64.87002802,61.76267471,50.00813833,49.21658213,44.7192314,68.52546636,523.033035),
  percentDetIV=c(56.05863315,69.96305861,65.26779917,64.87002802,61.76267471,50.00813833,49.21658213,44.7192314,68.52546636,100),
  percentDetIII=c(1.531852666,2.002520063,11.9155664,13.69204969,12.73584472,15.55312172,14.56022345,17.60362523,49.27283932,85.76724626)
  )

  PopEdats$RealCasesIII=c(PopEdats$pop[1]*PopEdats$prevIII[1]/100,
                 PopEdats$pop[2]*PopEdats$prevIII[2]/100,
                 PopEdats$pop[3]*PopEdats$prevIII[3]/100,
                 PopEdats$pop[4]*PopEdats$prevIII[4]/100,
                 PopEdats$pop[5]*PopEdats$prevIII[5]/100,
                 PopEdats$pop[6]*PopEdats$prevIII[6]/100,
                 PopEdats$pop[7]*PopEdats$prevIII[7]/100,
                 PopEdats$pop[8]*PopEdats$prevIII[8]/100,
                 PopEdats$pop[9]*PopEdats$prevIII[9]/100,
                 PopEdats$pop[10]*PopEdats$prevIII[10]/100)
  
    PopEdats$RealCasesVI.III=c(PopEdats$pop[1]*PopEdats$prevIv.III[1]/100,
                PopEdats$pop[2]*PopEdats$prevIv.III[2]/100,
                PopEdats$pop[3]*PopEdats$prevIv.III[3]/100,
                PopEdats$pop[4]*PopEdats$prevIv.III[4]/100,
                PopEdats$pop[5]*PopEdats$prevIv.III[5]/100,
                PopEdats$pop[6]*PopEdats$prevIv.III[6]/100,
                PopEdats$pop[7]*PopEdats$prevIv.III[7]/100,
                PopEdats$pop[8]*PopEdats$prevIv.III[8]/100,
                PopEdats$pop[9]*PopEdats$prevIv.III[9]/100,
                PopEdats$pop[10]*PopEdats$prevIv.III[10]/100)
    
  PopEdats$DetectedCasesIII=c(casesRoundIII$Sum09,
                     casesRoundIII$Sum19,
                     casesRoundIII$Sum29,
                     casesRoundIII$Sum39,
                     casesRoundIII$Sum49,
                     casesRoundIII$Sum59,
                     casesRoundIII$Sum69,
                     casesRoundIII$Sum79,
                     casesRoundIII$Sum89,
                     casesRoundIII$Sum90)
  
  PopEdats$DetectedCasesIV.III=c(casesRoundIV.III$Sum09,
                        casesRoundIV.III$Sum19,
                        casesRoundIV.III$Sum29,
                        casesRoundIV.III$Sum39,
                        casesRoundIV.III$Sum49,
                        casesRoundIV.III$Sum59,
                        casesRoundIV.III$Sum69,
                        casesRoundIV.III$Sum79,
                        casesRoundIV.III$Sum89,
                        casesRoundIV.III$Sum90)

  PopEdats$percentDetIII[1]=PopEdats$DetectedCasesIII[1]*100/PopEdats$RealCasesIII[1]
  PopEdats$percentDetIII[2]=PopEdats$DetectedCasesIII[2]*100/PopEdats$RealCasesIII[2]
  PopEdats$percentDetIII[3]=PopEdats$DetectedCasesIII[3]*100/PopEdats$RealCasesIII[3]
  PopEdats$percentDetIII[4]=PopEdats$DetectedCasesIII[4]*100/PopEdats$RealCasesIII[4]
  PopEdats$percentDetIII[5]=PopEdats$DetectedCasesIII[5]*100/PopEdats$RealCasesIII[5]
  PopEdats$percentDetIII[6]=PopEdats$DetectedCasesIII[6]*100/PopEdats$RealCasesIII[6]
  PopEdats$percentDetIII[7]=PopEdats$DetectedCasesIII[7]*100/PopEdats$RealCasesIII[7]
  PopEdats$percentDetIII[8]=PopEdats$DetectedCasesIII[8]*100/PopEdats$RealCasesIII[8]
  PopEdats$percentDetIII[9]=PopEdats$DetectedCasesIII[9]*100/PopEdats$RealCasesIII[9]
  PopEdats$percentDetIII[10]=PopEdats$DetectedCasesIII[10]*100/PopEdats$RealCasesIII[10]

  PopEdats$percentDetVI.III[1]=PopEdats$DetectedCasesIV.III[1]*100/PopEdats$RealCasesVI.III[1]
  PopEdats$percentDetVI.III[2]=PopEdats$DetectedCasesIV.III[2]*100/PopEdats$RealCasesVI.III[2]
  PopEdats$percentDetVI.III[3]=PopEdats$DetectedCasesIV.III[3]*100/PopEdats$RealCasesVI.III[3]
  PopEdats$percentDetVI.III[4]=PopEdats$DetectedCasesIV.III[4]*100/PopEdats$RealCasesVI.III[4]
  PopEdats$percentDetVI.III[5]=PopEdats$DetectedCasesIV.III[5]*100/PopEdats$RealCasesVI.III[5]
  PopEdats$percentDetVI.III[6]=PopEdats$DetectedCasesIV.III[6]*100/PopEdats$RealCasesVI.III[6]
  PopEdats$percentDetVI.III[7]=PopEdats$DetectedCasesIV.III[7]*100/PopEdats$RealCasesVI.III[7]
  PopEdats$percentDetVI.III[8]=PopEdats$DetectedCasesIV.III[8]*100/PopEdats$RealCasesVI.III[8]
  PopEdats$percentDetVI.III[9]=PopEdats$DetectedCasesIV.III[9]*100/PopEdats$RealCasesVI.III[9]
  PopEdats$percentDetVI.III[10]=PopEdats$DetectedCasesIV.III[10]*100/PopEdats$RealCasesVI.III[10]
    
  catPonderation=TRUE
  if(catPonderation)
  {
    totalRealCasesIII=sum(PopEdats$RealCasesIII)
    totaDecetctedCasesII=sum(PopEdats$DetectedCasesIII)
    totalPercDetecIII=totaDecetctedCasesII*100/totalRealCasesIII

    PopEdats$percentDetIII[1]=PopEdats$DetectedCasesIII[1]*100/PopEdats$RealCasesIII[1]*prevalenceCAT$percentDetIII/totalPercDetecIII
    PopEdats$percentDetIII[2]=PopEdats$DetectedCasesIII[2]*100/PopEdats$RealCasesIII[2]*prevalenceCAT$percentDetIII/totalPercDetecIII
    PopEdats$percentDetIII[3]=PopEdats$DetectedCasesIII[3]*100/PopEdats$RealCasesIII[3]*prevalenceCAT$percentDetIII/totalPercDetecIII
    PopEdats$percentDetIII[4]=PopEdats$DetectedCasesIII[4]*100/PopEdats$RealCasesIII[4]*prevalenceCAT$percentDetIII/totalPercDetecIII
    PopEdats$percentDetIII[5]=PopEdats$DetectedCasesIII[5]*100/PopEdats$RealCasesIII[5]*prevalenceCAT$percentDetIII/totalPercDetecIII
    PopEdats$percentDetIII[6]=PopEdats$DetectedCasesIII[6]*100/PopEdats$RealCasesIII[6]*prevalenceCAT$percentDetIII/totalPercDetecIII
    PopEdats$percentDetIII[7]=PopEdats$DetectedCasesIII[7]*100/PopEdats$RealCasesIII[7]*prevalenceCAT$percentDetIII/totalPercDetecIII
    PopEdats$percentDetIII[8]=PopEdats$DetectedCasesIII[8]*100/PopEdats$RealCasesIII[8]*prevalenceCAT$percentDetIII/totalPercDetecIII
    PopEdats$percentDetIII[9]=PopEdats$DetectedCasesIII[9]*100/PopEdats$RealCasesIII[9]*prevalenceCAT$percentDetIII/totalPercDetecIII
    PopEdats$percentDetIII[10]=PopEdats$DetectedCasesIII[10]*100/PopEdats$RealCasesIII[10]*prevalenceCAT$percentDetIII/totalPercDetecIII

    totalRealCasesVI.III=sum(PopEdats$RealCasesVI.III)
    totaDecetctedCasesVI.III=sum(PopEdats$DetectedCasesIV.III)
    totalPercDetecVI.III=totaDecetctedCasesVI.III*100/totalRealCasesVI.III

    PopEdats$percentDetVI.III[1]=PopEdats$DetectedCasesIV.III[1]*100/PopEdats$RealCasesVI.III[1]*prevalenceCAT$percentDetVI.III/totalPercDetecVI.III
    PopEdats$percentDetVI.III[2]=PopEdats$DetectedCasesIV.III[2]*100/PopEdats$RealCasesVI.III[2]*prevalenceCAT$percentDetVI.III/totalPercDetecVI.III
    PopEdats$percentDetVI.III[3]=PopEdats$DetectedCasesIV.III[3]*100/PopEdats$RealCasesVI.III[3]*prevalenceCAT$percentDetVI.III/totalPercDetecVI.III
    PopEdats$percentDetVI.III[4]=PopEdats$DetectedCasesIV.III[4]*100/PopEdats$RealCasesVI.III[4]*prevalenceCAT$percentDetVI.III/totalPercDetecVI.III
    PopEdats$percentDetVI.III[5]=PopEdats$DetectedCasesIV.III[5]*100/PopEdats$RealCasesVI.III[5]*prevalenceCAT$percentDetVI.III/totalPercDetecVI.III
    PopEdats$percentDetVI.III[6]=PopEdats$DetectedCasesIV.III[6]*100/PopEdats$RealCasesVI.III[6]*prevalenceCAT$percentDetVI.III/totalPercDetecVI.III
    PopEdats$percentDetVI.III[7]=PopEdats$DetectedCasesIV.III[7]*100/PopEdats$RealCasesVI.III[7]*prevalenceCAT$percentDetVI.III/totalPercDetecVI.III
    PopEdats$percentDetVI.III[8]=PopEdats$DetectedCasesIV.III[8]*100/PopEdats$RealCasesVI.III[8]*prevalenceCAT$percentDetVI.III/totalPercDetecVI.III
    PopEdats$percentDetVI.III[9]=PopEdats$DetectedCasesIV.III[9]*100/PopEdats$RealCasesVI.III[9]*prevalenceCAT$percentDetVI.III/totalPercDetecVI.III
    PopEdats$percentDetVI.III[10]=PopEdats$DetectedCasesIV.III[10]*100/PopEdats$RealCasesVI.III[10]*prevalenceCAT$percentDetVI.III/totalPercDetecVI.III
  }
  

AllData$totalPond<-AllData$casosPositiusData*100/ifelse(AllData$Data<='2020-06-22',prevalenceCAT$percentDetIII,prevalenceCAT$percentDetVI.III)

AllData$Sub09Pond<-AllData$Sub9*100/ifelse(AllData$Data<='2020-06-22',PopEdats$percentDetIII[1],PopEdats$percentDetVI.III[1])
AllData$Sub19Pond<-AllData$Sub19*100/ifelse(AllData$Data<='2020-06-22',PopEdats$percentDetIII[2],PopEdats$percentDetVI.III[2])
AllData$Sub29Pond<-AllData$Sub29*100/ifelse(AllData$Data<='2020-06-22',PopEdats$percentDetIII[3],PopEdats$percentDetVI.III[3])
AllData$Sub39Pond<-AllData$Sub39*100/ifelse(AllData$Data<='2020-06-22',PopEdats$percentDetIII[4],PopEdats$percentDetVI.III[4])
AllData$Sub49Pond<-AllData$Sub49*100/ifelse(AllData$Data<='2020-06-22',PopEdats$percentDetIII[5],PopEdats$percentDetVI.III[5])
AllData$Sub59Pond<-AllData$Sub59*100/ifelse(AllData$Data<='2020-06-22',PopEdats$percentDetIII[6],PopEdats$percentDetVI.III[6])
AllData$Sub69Pond<-AllData$Sub69*100/ifelse(AllData$Data<='2020-06-22',PopEdats$percentDetIII[7],PopEdats$percentDetVI.III[7])
AllData$Sub79Pond<-AllData$Sub79*100/ifelse(AllData$Data<='2020-06-22',PopEdats$percentDetIII[8],PopEdats$percentDetVI.III[8])
AllData$Sub89Pond<-AllData$Sub89*100/ifelse(AllData$Data<='2020-06-22',PopEdats$percentDetIII[9],PopEdats$percentDetVI.III[9])
AllData$Sub90Pond<-AllData$Sub90*100/ifelse(AllData$Data<='2020-06-22',PopEdats$percentDetIII[10],PopEdats$percentDetVI.III[10])


#Afegim taxa per franja d'edat.
centK<-100000

AllData$taxa<-(AllData$casosPositiusData/sum(PopEdats$pop))*centK
AllData$taxaSub09<-(AllData$Sub9/PopEdats$pop[1])*centK
AllData$taxaSub19<-(AllData$Sub19/PopEdats$pop[2])*centK
AllData$taxaSub29<-(AllData$Sub29/PopEdats$pop[3])*centK
AllData$taxaSub39<-(AllData$Sub39/PopEdats$pop[4])*centK
AllData$taxaSub49<-(AllData$Sub49/PopEdats$pop[5])*centK
AllData$taxaSub59<-(AllData$Sub59/PopEdats$pop[6])*centK
AllData$taxaSub69<-(AllData$Sub69/PopEdats$pop[7])*centK
AllData$taxaSub79<-(AllData$Sub79/PopEdats$pop[8])*centK
AllData$taxaSub89<-(AllData$Sub89/PopEdats$pop[9])*centK
AllData$taxaSub90<-(AllData$Sub90/PopEdats$pop[10])*centK


AllData$taxaPond<-AllData$taxa*100/ifelse(AllData$Data<='2020-06-22',prevalenceCAT$percentDetIII,prevalenceCAT$percentDetVI.III)

AllData$taxaSub09Pond<-AllData$taxaSub09*100/ifelse(AllData$Data<='2020-06-22',PopEdats$percentDetIII[1],PopEdats$percentDetVI.III[1])
AllData$taxaSub19Pond<-AllData$taxaSub19*100/ifelse(AllData$Data<='2020-06-22',PopEdats$percentDetIII[2],PopEdats$percentDetVI.III[2])
AllData$taxaSub29Pond<-AllData$taxaSub29*100/ifelse(AllData$Data<='2020-06-22',PopEdats$percentDetIII[3],PopEdats$percentDetVI.III[3])
AllData$taxaSub39Pond<-AllData$taxaSub39*100/ifelse(AllData$Data<='2020-06-22',PopEdats$percentDetIII[4],PopEdats$percentDetVI.III[4])
AllData$taxaSub49Pond<-AllData$taxaSub49*100/ifelse(AllData$Data<='2020-06-22',PopEdats$percentDetIII[5],PopEdats$percentDetVI.III[5])
AllData$taxaSub59Pond<-AllData$taxaSub59*100/ifelse(AllData$Data<='2020-06-22',PopEdats$percentDetIII[6],PopEdats$percentDetVI.III[6])
AllData$taxaSub69Pond<-AllData$taxaSub69*100/ifelse(AllData$Data<='2020-06-22',PopEdats$percentDetIII[7],PopEdats$percentDetVI.III[7])
AllData$taxaSub79Pond<-AllData$taxaSub79*100/ifelse(AllData$Data<='2020-06-22',PopEdats$percentDetIII[8],PopEdats$percentDetVI.III[8])
AllData$taxaSub89Pond<-AllData$taxaSub89*100/ifelse(AllData$Data<='2020-06-22',PopEdats$percentDetIII[9],PopEdats$percentDetVI.III[9])
AllData$taxaSub90Pond<-AllData$taxaSub90*100/ifelse(AllData$Data<='2020-06-22',PopEdats$percentDetIII[10],PopEdats$percentDetVI.III[10])

AllData$ID <- seq.int(nrow(AllData))
#Cnsiderem l'anàlisi fins el dia XXXX

 library(readxl)

 # write.csv(AllData, "AllData.csv") #In case
 writexl::write_xlsx(AllData, "AllData.xlsx")
 
 ###################### Analysis parameters
 DiesEfecteTancament <- 29 # 29 Per fer 260

 #PEr analitzar Omicron
 IniciOmicron="2021-11-12"
 FinalOmicron="2022-02-03"
 TancamentBarsOmicron="2021-12-23"
 DiaOberturaEscolesOmicron="2022-01-10"
 TancamentBarsIndexOmicron <- which(grepl(TancamentBarsOmicron, AllData$Data))
 IniciFaseOmicronIndex <- which(grepl(IniciOmicron, AllData$Data))
 
 #Per analitzar segona onada
 IniciFase0="2020-05-04"
 IniciFase0="2020-02-29" #"2020-02-29"
 TancamentBars="2020-10-16" 
 DiaOberturaEscoles="2020-09-14"
 TancamentBarsIndex <- which(grepl(TancamentBars, AllData$Data))
 
 IniciFase0Index <- which(grepl(IniciFase0, AllData$Data))
 # IniciFase0 <- EndRoundIIIIndex
 # IniciFase0Index <- 0
 OmicronAnaysis=0
 if(OmicronAnaysis==0)
 {
    IniciGranger=IniciFase0Index
    FinalGranger=TancamentBarsIndex+DiesEfecteTancament
 } else
  {
    DiaOberturaEscoles=DiaOberturaEscolesOmicron
    IniciGranger=IniciFaseOmicronIndex
    FinalGranger=TancamentBarsIndex+DiesEfecteTancament
  }

 

 AllDataGRanger <- AllData

 AllDataGRanger=head(AllDataGRanger,TancamentBarsIndex+DiesEfecteTancament)
 AllDataGRanger=tail(AllDataGRanger,nrow(AllDataGRanger)-IniciFase0Index)
 # AllDataGRanger=ts(AllDataGRanger)
 
 AllDataGRangerOmicron <- AllData

 AllDataGRangerOmicron=head(AllDataGRangerOmicron,TancamentBarsIndex+DiesEfecteTancament)
 AllDataGRangerOmicron=tail(AllDataGRangerOmicron,nrow(AllDataGRangerOmicron)-IniciFase0Index)
 
 
 PopEdatsNewRange <- data.frame(
  edat=c("0-15","16-64","65-74","+75"),
  pop=c(1179015,5079033,739037,725118)
  )
 
 # AllData$casosSub15Taxa<-(AllData$casosSub15/PopEdatsNewRange$pop[1])*centK
 # AllData$casosSub65Taxa<-(AllData$casosSub65/PopEdatsNewRange$pop[2])*centK
 # AllData$casosSub75Taxa<-(AllData$casosSub74/PopEdatsNewRange$pop[3])*centK
 # AllData$casosAvisTaxa<-(AllData$casosAvis/PopEdatsNewRange$pop[4])*centK
 
 
 # PCRs
keeps <- c("Group.1","x")
PCRsSub39Data <- read.csv("G:/My Drive/2020 - Pandemia/datasets/Schools/PCRsAduls39Data.csv")
PCRsSub39Data <- PCRsSub39Data[keeps]
PCRsSub49Data <- read.csv("G:/My Drive/2020 - Pandemia/datasets/Schools/PCRsAduls49Data.csv")
PCRsSub49Data <- PCRsSub49Data[keeps]
PCRsSub59Data <- read.csv("G:/My Drive/2020 - Pandemia/datasets/Schools/PCRsAduls59Data.csv")
PCRsSub59Data <- PCRsSub59Data[keeps]
PCRsSub69Data <- read.csv("G:/My Drive/2020 - Pandemia/datasets/Schools/PCRsAduls69Data.csv")
PCRsSub69Data <- PCRsSub69Data[keeps]
PCRsSub79Data <- read.csv("G:/My Drive/2020 - Pandemia/datasets/Schools/PCRsAduls79Data.csv")
PCRsSub79Data <- PCRsSub79Data[keeps]
PCRsSub89Data <- read.csv("G:/My Drive/2020 - Pandemia/datasets/Schools/PCRsAduls89Data.csv")
PCRsSub89Data <- PCRsSub89Data[keeps]
PCRsSub90Data <- read.csv("G:/My Drive/2020 - Pandemia/datasets/Schools/PCRsAduls90Data.csv")
PCRsSub90Data <- PCRsSub90Data[keeps]
PCRsSub29Data <- read.csv("G:/My Drive/2020 - Pandemia/datasets/Schools/PCRsJovesData.csv")
PCRsSub29Data <- PCRsSub29Data[keeps]
PCRsSub19Data <- read.csv("G:/My Drive/2020 - Pandemia/datasets/Schools/PCRsMenorBsData.csv")
PCRsSub19Data <- PCRsSub19Data[keeps]
PCRsSub09Data <- read.csv("G:/My Drive/2020 - Pandemia/datasets/Schools/PCRsMenorsData.csv")
PCRsSub09Data <- PCRsSub09Data[keeps]


AllOldPCRsData <- merge(PCRsSub39Data, PCRsSub49Data, by="Group.1", all.x=TRUE, all.y=TRUE)
AllOldPCRsData <- merge(AllOldPCRsData, PCRsSub59Data, by="Group.1", all.x=TRUE)
AllOldPCRsData <- merge(AllOldPCRsData, PCRsSub69Data, by="Group.1", all.x=TRUE)

AllOldPCRsData <- merge(AllOldPCRsData, PCRsSub79Data, by="Group.1", all.x=TRUE)
AllOldPCRsData <- merge(AllOldPCRsData, PCRsSub89Data, by="Group.1", all.x=TRUE)

AllOldPCRsData <- merge(AllOldPCRsData, PCRsSub90Data, by="Group.1", all.x=TRUE)

AllOldPCRsData <- merge(AllOldPCRsData, PCRsSub29Data, by="Group.1", all.x=TRUE)
AllOldPCRsData <- merge(AllOldPCRsData, PCRsSub19Data, by="Group.1", all.x=TRUE)
AllOldPCRsData <- merge(AllOldPCRsData, PCRsSub09Data, by="Group.1", all.x=TRUE)


AllOldPCRsData[is.na(AllOldPCRsData)] <- 0
colnames(AllOldPCRsData) <- c("Data","Sub39", "Sub49", "Sub59", "Sub69", "Sub79", "Sub89", "Sub90", "Sub29", "Sub19","Sub09")
  
```

Row
-------------------------------------

### Subserie analyzed

```{r Series_chart, echo=FALSE}

fig <- plot_ly(type="bar", 
               x = AllDataGRanger$Data,
               y = AllDataGRanger$casosPositiusData,
               name = 'observations',
               text = paste("new cases"))

annotation1 <- list(yref = 'y', xref = "x", y = 300, x = "2020-05-04", text = "Start phase 0")
annotation2 <- list(yref = 'y', xref = "x", y = 4000, x = "2020-10-16", text = "Closing bars")
fig <- fig %>% add_trace(y = AllDataGRanger$Sub9, x=AllDataGRanger$Data, type='scatter', mode = 'lines', name='0-9') %>% layout(annotations= list(annotation1,annotation2))
fig <- fig %>% add_trace(y = AllDataGRanger$Sub19, x=AllDataGRanger$Data, type='scatter', mode = 'lines', name='10-19')
fig <- fig %>% add_trace(y = AllDataGRanger$Sub29, x=AllDataGRanger$Data, type='scatter', mode = 'lines', name='20-29')
fig <- fig %>% add_trace(y = AllDataGRanger$Sub39, x=AllDataGRanger$Data, type='scatter', mode = 'lines', name='30-39')
fig <- fig %>% add_trace(y = AllDataGRanger$Sub49, x=AllDataGRanger$Data, type='scatter', mode = 'lines', name='40-49')
fig <- fig %>% add_trace(y = AllDataGRanger$Sub59, x=AllDataGRanger$Data, type='scatter', mode = 'lines', name='50-59')
fig <- fig %>% add_trace(y = AllDataGRanger$Sub69, x=AllDataGRanger$Data, type='scatter', mode = 'lines', name='60-69')
fig <- fig %>% add_trace(y = AllDataGRanger$Sub79, x=AllDataGRanger$Data, type='scatter', mode = 'lines', name='70-79')
fig <- fig %>% add_trace(y = AllDataGRanger$Sub89, x=AllDataGRanger$Data, type='scatter', mode = 'lines', name='80-89')
fig <- fig %>% add_trace(y = AllDataGRanger$Sub90, x=AllDataGRanger$Data, type='scatter', mode = 'lines', name='90+')

fig

```

Row
-------------------------------------

### Analysis start date

```{r parametersInici, echo=FALSE}
articles <- paste("Date:",IniciFase0)
valueBox(articles, icon = "fa-pencil", color = "primary")
```

### Closing bars

```{r parametersFinal, echo=FALSE}
articles <- paste("Date:",TancamentBars)
valueBox(articles, icon = "fa-pencil", color = "primary")
```

### Non-pharmateutical intervention days to effect

```{r parametersFinalEfecte, echo=FALSE}
articles <- paste("Days:",DiesEfecteTancament)
valueBox(articles, icon = "fa-pencil", color = "primary")
```


Real time charts {data-icon="fa-list"}
===============================================================

Charts with information from Catalonia Open Data sources.

Row
-------------------------------------

### Number of cases by age


```{r global_chart, echo=FALSE}

xx = casosPositiusSub19$x
x.info = attr(xx, "tsp")
#tt = seq(from=x.info[1], to = x.info[2], by=1/x.info[3])
data.fmt = list(color=rgb(0.8,0.8,0.8,0.8), width=4)
line.fmt = list(dash="solid", width = 1.5, color=NULL)
 
ti = 1:length(xx)
m1 = lm(xx~ti)
m2 = lm(xx~ti+I(ti^2))
m3 = lm(xx~ti+I(ti^2)+I(ti^3))

fig <- plot_ly(type="bar", 
               x = AllData$Data,
               y = AllData$casosPositiusData,
               name = 'observations',
               text = paste("new cases"))

annotation1 <- list(yref = 'y', xref = "x", y = 300, x = "2020-03-14", text = "Estat d'alarma")
annotation2 <- list(yref = 'y', xref = "x", y = 200, x = "2020-06-24", text = "Sant Joan")
annotation3 <- list(yref = 'y', xref = "x", y = 1500, x = "2020-09-15", text = "Inici escoles")
fig <- fig %>% add_trace(y = AllData$Sub9, x=AllData$Data, type='scatter', mode = 'lines', name='0-9') %>% layout(annotations= list(annotation1,annotation2))
fig <- fig %>% add_trace(y = AllData$Sub19, x=AllData$Data, type='scatter', mode = 'lines', name='10-19')

fig <- fig %>% add_trace(y = AllData$Sub29, x=AllData$Data, type='scatter', mode = 'lines', name='20-29')
fig <- fig %>% add_trace(y = AllData$Sub39, x=AllData$Data, type='scatter', mode = 'lines', name='30-39')
fig <- fig %>% add_trace(y = AllData$Sub49, x=AllData$Data, type='scatter', mode = 'lines', name='40-49')
fig <- fig %>% add_trace(y = AllData$Sub59, x=AllData$Data, type='scatter', mode = 'lines', name='50-59')
fig <- fig %>% add_trace(y = AllData$Sub69, x=AllData$Data, type='scatter', mode = 'lines', name='60-69')
fig <- fig %>% add_trace(y = AllData$Sub79, x=AllData$Data, type='scatter', mode = 'lines', name='70-79')
fig <- fig %>% add_trace(y = AllData$Sub89, x=AllData$Data, type='scatter', mode = 'lines', name='80-89')
fig <- fig %>% add_trace(y = AllData$Sub90, x=AllData$Data, type='scatter', mode = 'lines', name='90+')

fig

```



Row
-------------------------------------
### Rates of detected cases
Evolution of the rates by age.

```{r Cases(2), echo=FALSE}


fig <- plot_ly(type="bar", 
               x = AllData$Data,
               y = AllData$taxa,
               name = 'observations',
               text = paste("new cases"))

annotation1 <- list(yref = 'y', xref = "x", y = 300, x = "2020-03-14", text = "Estat d'alarma")
annotation2 <- list(yref = 'y', xref = "x", y = 200, x = "2020-06-24", text = "Sant Joan")
annotation3 <- list(yref = 'y', xref = "x", y = 1500, x = "2020-09-15", text = "Inici escoles")
fig <- fig %>% add_trace(y = AllData$taxaSub09, x=AllData$Data, type='scatter', mode = 'lines', name='0-9') #%>% layout(annotations= list(annotation1,annotation2,annotation3))
fig <- fig %>% add_trace(y = AllData$taxaSub19, x=AllData$Data, type='scatter', mode = 'lines', name='10-19')

fig <- fig %>% add_trace(y = AllData$taxaSub29, x=AllData$Data, type='scatter', mode = 'lines', name='20-29')
fig <- fig %>% add_trace(y = AllData$taxaSub39, x=AllData$Data, type='scatter', mode = 'lines', name='30-39')
fig <- fig %>% add_trace(y = AllData$taxaSub49, x=AllData$Data, type='scatter', mode = 'lines', name='40-49')
fig <- fig %>% add_trace(y = AllData$taxaSub59, x=AllData$Data, type='scatter', mode = 'lines', name='50-59')
fig <- fig %>% add_trace(y = AllData$taxaSub69, x=AllData$Data, type='scatter', mode = 'lines', name='60-69')
fig <- fig %>% add_trace(y = AllData$taxaSub79, x=AllData$Data, type='scatter', mode = 'lines', name='70-79')
fig <- fig %>% add_trace(y = AllData$taxaSub89, x=AllData$Data, type='scatter', mode = 'lines', name='80-89')
fig <- fig %>% add_trace(y = AllData$taxaSub90, x=AllData$Data, type='scatter', mode = 'lines', name='90+')

fig

```

<!-- Row -->
<!-- ------------------------------------- -->

<!-- ### Rates of cases by age (New data ranges) -->


<!-- ```{r global_chart_newTAxes, echo=FALSE} -->

<!-- #CAses by the new ages ranges (3) -->

<!-- figPCRs <- plot_ly(type="bar", -->
<!--                x = AllData$Data, -->
<!--                y = AllData$taxa, -->
<!--                name = 'observations', -->
<!--                text = paste("All data")) -->

<!-- figPCRs <- figPCRs %>% add_trace(y = AllData$casosSub15Taxa, x=AllData$Data, type='scatter', mode = 'lines', name='0-15') -->
<!-- figPCRs <- figPCRs %>% add_trace(y = AllData$casosSub65Taxa, x=AllData$Data, type='scatter', mode = 'lines', name='16-64') -->
<!-- figPCRs <- figPCRs %>% add_trace(y = AllData$casosSub75Taxa, x=AllData$Data, type='scatter', mode = 'lines', name='65-74') -->
<!-- figPCRs <- figPCRs %>% add_trace(y = AllData$casosAvisTaxa, x=AllData$Data, type='scatter', mode = 'lines', name='75+') -->

<!-- figPCRs -->

<!-- ``` -->

Row
-------------------------------------
### Rates of detected cases smoth
Evolution of the rates by age smooth by loess

```{r Cases(3), echo=FALSE}


fig <- plot_ly(type="bar", 
               x = AllData$Data,
               y = AllData$taxa,
               name = 'observations',
               text = paste("new cases"))

annotation1 <- list(yref = 'y', xref = "x", y = 300, x = "2020-03-14", text = "Estat d'alarma")
annotation2 <- list(yref = 'y', xref = "x", y = 200, x = "2020-06-24", text = "Sant Joan")
annotation3 <- list(yref = 'y', xref = "x", y = 1500, x = "2020-09-15", text = "Inici escoles")

# http://r-statistics.co/Loess-Regression-With-R.html
loessMod10 <- loess(AllData$taxaSub09~AllData$ID, span=0.10)
fig <- fig %>% add_trace(y = predict(loessMod10), x=AllData$Data, type='scatter', mode = 'lines', name='0-9') #%>% layout(annotations= list(annotation1,annotation2,annotation3))

loessMod10 <- loess(AllData$taxaSub19~AllData$ID, span=0.10)
fig <- fig %>% add_trace(y = predict(loessMod10), x=AllData$Data, type='scatter', mode = 'lines', name='10-19')

loessMod10 <- loess(AllData$taxaSub29~AllData$ID, span=0.10)
fig <- fig %>% add_trace(y = predict(loessMod10), x=AllData$Data, type='scatter', mode = 'lines', name='20-29')

loessMod10 <- loess(AllData$taxaSub39~AllData$ID, span=0.10)
fig <- fig %>% add_trace(y = predict(loessMod10), x=AllData$Data, type='scatter', mode = 'lines', name='30-39')

loessMod10 <- loess(AllData$taxaSub49~AllData$ID, span=0.10)
fig <- fig %>% add_trace(y = predict(loessMod10), x=AllData$Data, type='scatter', mode = 'lines', name='40-49')

loessMod10 <- loess(AllData$taxaSub59~AllData$ID, span=0.10)
fig <- fig %>% add_trace(y = predict(loessMod10), x=AllData$Data, type='scatter', mode = 'lines', name='50-59')

loessMod10 <- loess(AllData$taxaSub69~AllData$ID, span=0.10)
fig <- fig %>% add_trace(y = predict(loessMod10), x=AllData$Data, type='scatter', mode = 'lines', name='60-69')

loessMod10 <- loess(AllData$taxaSub79~AllData$ID, span=0.10)
fig <- fig %>% add_trace(y = predict(loessMod10), x=AllData$Data, type='scatter', mode = 'lines', name='70-79')

loessMod10 <- loess(AllData$taxaSub89~AllData$ID, span=0.10)
fig <- fig %>% add_trace(y = predict(loessMod10), x=AllData$Data, type='scatter', mode = 'lines', name='80-89')

loessMod10 <- loess(AllData$taxaSub90~AllData$ID, span=0.10)
fig <- fig %>% add_trace(y = predict(loessMod10), x=AllData$Data, type='scatter', mode = 'lines', name='90+')


fig

```

<!-- Row -->
<!-- ------------------------------------- -->

<!-- ### Rates of cases by age (New data ranges) -->


<!-- ```{r global_chart_newTAxesSmooth, echo=FALSE} -->

<!-- #CAses by the new ages ranges (3) -->

<!-- figPCRs <- plot_ly(type="bar", -->
<!--                x = AllData$Data, -->
<!--                y = AllData$taxa, -->
<!--                name = 'observations', -->
<!--                text = paste("All data")) -->

<!-- loessMod10 <- loess(AllData$casosSub15Taxa~AllData$ID, span=0.10) -->
<!-- figPCRs <- figPCRs %>% add_trace(y = predict(loessMod10), x=AllData$Data, type='scatter', mode = 'lines', name='0-15') -->
<!-- loessMod10 <- loess(AllData$casosSub65Taxa~AllData$ID, span=0.10) -->
<!-- figPCRs <- figPCRs %>% add_trace(y = predict(loessMod10), x=AllData$Data, type='scatter', mode = 'lines', name='16-64') -->
<!-- loessMod10 <- loess(AllData$casosSub75Taxa~AllData$ID, span=0.10) -->
<!-- figPCRs <- figPCRs %>% add_trace(y = predict(loessMod10), x=AllData$Data, type='scatter', mode = 'lines', name='65-74') -->
<!-- loessMod10 <- loess(AllData$casosAvisTaxa~AllData$ID, span=0.10) -->
<!-- figPCRs <- figPCRs %>% add_trace(y = predict(loessMod10), x=AllData$Data, type='scatter', mode = 'lines', name='75+') -->

<!-- figPCRs -->

<!-- ``` -->

Row
-------------------------------------
### Prevalence
Prevalence analysis, to obtain the percent of detection in each age range.

```{r, echo=FALSE}
Rounds=NULL


Rounds<-data.frame(
  date=c("Round I", "Round II", "Round III", "Round IV"),
  Age09=c(PopEdats$prevI[1],PopEdats$prevII[1],PopEdats$prevIII[1],PopEdats$prevIV[1]),
  Age19=c(PopEdats$prevI[2],PopEdats$prevII[2],PopEdats$prevIII[2],PopEdats$prevIV[2]),
  Age29=c(PopEdats$prevI[3],PopEdats$prevII[3],PopEdats$prevIII[3],PopEdats$prevIV[3]),
  Age39=c(PopEdats$prevI[4],PopEdats$prevII[4],PopEdats$prevIII[4],PopEdats$prevIV[4]),
  Age49=c(PopEdats$prevI[5],PopEdats$prevII[5],PopEdats$prevIII[5],PopEdats$prevIV[5]),
  Age59=c(PopEdats$prevI[6],PopEdats$prevII[6],PopEdats$prevIII[6],PopEdats$prevIV[6]),
  Age69=c(PopEdats$prevI[7],PopEdats$prevII[7],PopEdats$prevIII[7],PopEdats$prevIV[7]),
  Age79=c(PopEdats$prevI[8],PopEdats$prevII[8],PopEdats$prevIII[8],PopEdats$prevIV[8]),
  Age89=c(PopEdats$prevI[9],PopEdats$prevII[9],PopEdats$prevIII[9],PopEdats$prevIV[9]),
  Age90=c(PopEdats$prevI[10],PopEdats$prevII[10],PopEdats$prevIII[10],PopEdats$prevIV[10])
)

figRound <- plot_ly(type="bar", 
               x =  Rounds$date,
               y = 0,
               name = 'Rounds',
               text = paste("prevalence"))

figRound <- figRound %>% add_trace(y = Rounds$Age09, x=Rounds$date, type='scatter', mode = 'lines', name='0-9') 
figRound <- figRound %>% add_trace(y = Rounds$Age19, x=Rounds$date, type='scatter', mode = 'lines', name='10-19')
figRound <- figRound %>% add_trace(y = Rounds$Age29, x=Rounds$date, type='scatter', mode = 'lines', name='20-29')
figRound <- figRound %>% add_trace(y = Rounds$Age39, x=Rounds$date, type='scatter', mode = 'lines', name='30-39')
figRound <- figRound %>% add_trace(y = Rounds$Age49, x=Rounds$date, type='scatter', mode = 'lines', name='40-49')
figRound <- figRound %>% add_trace(y = Rounds$Age59, x=Rounds$date, type='scatter', mode = 'lines', name='50-59')
figRound <- figRound %>% add_trace(y = Rounds$Age69, x=Rounds$date, type='scatter', mode = 'lines', name='60-69')
figRound <- figRound %>% add_trace(y = Rounds$Age79, x=Rounds$date, type='scatter', mode = 'lines', name='70-79')
figRound <- figRound %>% add_trace(y = Rounds$Age89, x=Rounds$date, type='scatter', mode = 'lines', name='80-89')
figRound <- figRound %>% add_trace(y = Rounds$Age90, x=Rounds$date, type='scatter', mode = 'lines', name='90+')


figRound


```



Row
-------------------------------------
### PCRs
Number of tests done, global and by age.

```{r global_PCRs, echo=FALSE}

figPCRs <- plot_ly(type="bar",
               x = AllData$Data,
               y = AllData$PCRsData,
               name = 'observations',
               text = paste("new cases"))

annotation1 <- list(yref = 'y', xref = "x", y = 3000, x = "2020-03-14", text = "Alarm")
annotation2 <- list(yref = 'y', xref = "x", y = 5000, x = "2020-06-24", text = "Sant Joan")
annotation3 <- list(yref = 'y', xref = "x", y = 15000, x = "2020-09-15", text = "School opening")
figPCRs <- figPCRs %>% add_trace(y = AllData$PCRsSub09, x=AllData$Data, type='scatter', mode = 'lines', name='0 a 9') %>% layout(annotations= list(annotation1,annotation2,annotation3))
figPCRs <- figPCRs %>% add_trace(y = AllData$PCRsSub19, x=AllData$Data, type='scatter', mode = 'lines', name='10 a 19')
figPCRs <- figPCRs %>% add_trace(y = AllData$PCRsSub29, x=AllData$Data, type='scatter', mode = 'lines', name='20 a 29')
figPCRs <- figPCRs %>% add_trace(y = AllData$PCRsSub39, x=AllData$Data, type='scatter', mode = 'lines', name='30 a 39')
figPCRs <- figPCRs %>% add_trace(y = AllData$PCRsSub49, x=AllData$Data, type='scatter', mode = 'lines', name='40 a 49')
figPCRs <- figPCRs %>% add_trace(y = AllData$PCRsSub59, x=AllData$Data, type='scatter', mode = 'lines', name='50 a 59')
figPCRs <- figPCRs %>% add_trace(y = AllData$PCRsSub69, x=AllData$Data, type='scatter', mode = 'lines', name='60 a 69')
figPCRs <- figPCRs %>% add_trace(y = AllData$PCRsSub79, x=AllData$Data, type='scatter', mode = 'lines', name='70 a 79')
figPCRs <- figPCRs %>% add_trace(y = AllData$PCRsSub89, x=AllData$Data, type='scatter', mode = 'lines', name='80 o més')
figPCRs
```

<!-- Row -->
<!-- ------------------------------------- -->
<!-- ### PCRs -->
<!-- Number of tests done, global and by age. -->

<!-- ```{r global_PCRs_old, echo=FALSE} -->

<!-- fig <- plot_ly(type="bar",  -->
<!--                x = AllOldPCRsData$Data, -->
<!--                y = AllOldPCRsData$Sub90+AllOldPCRsData$Sub89+AllOldPCRsData$Sub79+AllOldPCRsData$Sub69+AllOldPCRsData$Sub59+AllOldPCRsData$Sub49+AllOldPCRsData$Sub39+AllOldPCRsData$Sub29+AllOldPCRsData$Sub19+AllOldPCRsData$Sub09, -->
<!--                name = 'observations', -->
<!--                text = paste("new cases")) -->

<!-- annotation1 <- list(yref = 'y', xref = "x", y = 300, x = "2020-03-14", text = "Alarm") -->
<!-- annotation2 <- list(yref = 'y', xref = "x", y = 50, x = "2020-06-24", text = "Sant Joan") -->
<!-- annotation3 <- list(yref = 'y', xref = "x", y = 300, x = "2020-09-15", text = "School opening") -->

<!-- fig <- fig %>% add_trace(y = AllOldPCRsData$Sub09, x=AllOldPCRsData$Data, type='scatter', mode = 'lines', name='0-9') %>% layout(annotations= list(annotation1,annotation2,annotation3)) -->
<!-- fig <- fig %>% add_trace(y = AllOldPCRsData$Sub19, x=AllOldPCRsData$Data, type='scatter', mode = 'lines', name='10-19') -->

<!-- fig <- fig %>% add_trace(y = AllOldPCRsData$Sub29, x=AllOldPCRsData$Data, type='scatter', mode = 'lines', name='20-29') -->
<!-- fig <- fig %>% add_trace(y = AllOldPCRsData$Sub39, x=AllOldPCRsData$Data, type='scatter', mode = 'lines', name='30-39') -->
<!-- fig <- fig %>% add_trace(y = AllOldPCRsData$Sub49, x=AllOldPCRsData$Data, type='scatter', mode = 'lines', name='40-49') -->
<!-- fig <- fig %>% add_trace(y = AllOldPCRsData$Sub59, x=AllOldPCRsData$Data, type='scatter', mode = 'lines', name='50-59') -->
<!-- fig <- fig %>% add_trace(y = AllOldPCRsData$Sub69, x=AllOldPCRsData$Data, type='scatter', mode = 'lines', name='60-69') -->
<!-- fig <- fig %>% add_trace(y = AllOldPCRsData$Sub79, x=AllOldPCRsData$Data, type='scatter', mode = 'lines', name='70-79') -->
<!-- fig <- fig %>% add_trace(y = AllOldPCRsData$Sub89, x=AllOldPCRsData$Data, type='scatter', mode = 'lines', name='80-89') -->
<!-- fig <- fig %>% add_trace(y = AllOldPCRsData$Sub90, x=AllOldPCRsData$Data, type='scatter', mode = 'lines', name='90+') -->

<!-- fig -->
<!-- ``` -->

Row
-------------------------------------
### Percent of Positivity

```{r, echo=FALSE}
AllData$percPos <- ifelse(AllData$casosPositiusData*100/AllData$PCRsData>100,100,AllData$casosPositiusData*100/AllData$PCRsData)
AllData$percPosSub09 <- ifelse(ifelse(AllData$Sub9==0,0,AllData$Sub9*100/AllData$PCRsSub09)>100,100,ifelse(AllData$Sub9==0,0,AllData$Sub9*100/AllData$PCRsSub09))
AllData$percPosSub19 <- ifelse(ifelse(AllData$Sub19==0,0,AllData$Sub19*100/AllData$PCRsSub19)>100,100,ifelse(AllData$Sub9==0,0,AllData$Sub19*100/AllData$PCRsSub19))
AllData$percPosSub29 <- ifelse(ifelse(AllData$Sub29==0,0,AllData$Sub29*100/AllData$PCRsSub29)>100,100,ifelse(AllData$Sub9==0,0,AllData$Sub29*100/AllData$PCRsSub29))
AllData$percPosSub39 <- ifelse(ifelse(AllData$Sub39==0,0,AllData$Sub39*100/AllData$PCRsSub39)>100,100,ifelse(AllData$Sub9==0,0,AllData$Sub39*100/AllData$PCRsSub39))
AllData$percPosSub49 <- ifelse(ifelse(AllData$Sub49==0,0,AllData$Sub49*100/AllData$PCRsSub49)>100,100,ifelse(AllData$Sub9==0,0,AllData$Sub49*100/AllData$PCRsSub49))
AllData$percPosSub59 <- ifelse(ifelse(AllData$Sub59==0,0,AllData$Sub59*100/AllData$PCRsSub59)>100,100,ifelse(AllData$Sub9==0,0,AllData$Sub59*100/AllData$PCRsSub59))
AllData$percPosSub69 <- ifelse(ifelse(AllData$Sub69==0,0,AllData$Sub69*100/AllData$PCRsSub69)>100,100,ifelse(AllData$Sub9==0,0,AllData$Sub69*100/AllData$PCRsSub69))
AllData$percPosSub79 <- ifelse(ifelse(AllData$Sub79==0,0,AllData$Sub79*100/AllData$PCRsSub79)>100,100,ifelse(AllData$Sub9==0,0,AllData$Sub79*100/AllData$PCRsSub79))
AllData$percPosSub89 <- ifelse(ifelse(AllData$Sub89==0,0,(AllData$Sub89+AllData$Sub90)*100/AllData$PCRsSub89),100,ifelse(AllData$Sub89==0,0,(AllData$Sub89+AllData$Sub90)*100/AllData$PCRsSub89))

AllData[is.na(AllData)] <- 0

fig <- plot_ly(type="bar",
               x = AllData$Data,
               y = AllData$percPos,
               name = '% positivity',
               text = paste("%"))

fig <- fig %>% add_trace(y = AllData$percPosSub09, x=AllData$Data, type='scatter', mode = 'lines', name='0-09')
fig <- fig %>% add_trace(y = AllData$percPosSub19, x=AllData$Data, type='scatter', mode = 'lines', name='0-19')
fig <- fig %>% add_trace(y = AllData$percPosSub29, x=AllData$Data, type='scatter', mode = 'lines', name='0-29')
fig <- fig %>% add_trace(y = AllData$percPosSub39, x=AllData$Data, type='scatter', mode = 'lines', name='0-39')
fig <- fig %>% add_trace(y = AllData$percPosSub49, x=AllData$Data, type='scatter', mode = 'lines', name='0-49')
fig <- fig %>% add_trace(y = AllData$percPosSub59, x=AllData$Data, type='scatter', mode = 'lines', name='0-59')
fig <- fig %>% add_trace(y = AllData$percPosSub69, x=AllData$Data, type='scatter', mode = 'lines', name='0-69')
fig <- fig %>% add_trace(y = AllData$percPosSub79, x=AllData$Data, type='scatter', mode = 'lines', name='0-79')
fig <- fig %>% add_trace(y = AllData$percPosSub89, x=AllData$Data, type='scatter', mode = 'lines', name='0-89')

fig

```

Row
-------------------------------------
### Evolution of the cases by percent of detection (real cases)
The percent of detection to obtain the real cases are based on the prevalence. We apply if for the different rounbds, being the Round I to III almost the same

```{r Cases_perDet, echo=FALSE}


fig <- plot_ly(type="bar", 
               x = AllData$Data,
               y = AllData$totalPond,
               name = 'observations',
               text = paste("new cases"))

fig <- fig %>% add_trace(y = AllData$Sub09Pond, x=AllData$Data, type='scatter', mode = 'lines', name='0-9') 
fig <- fig %>% add_trace(y = AllData$Sub19Pond, x=AllData$Data, type='scatter', mode = 'lines', name='10-19')

fig <- fig %>% add_trace(y = AllData$Sub29Pond, x=AllData$Data, type='scatter', mode = 'lines', name='20-29')
fig <- fig %>% add_trace(y = AllData$Sub39Pond, x=AllData$Data, type='scatter', mode = 'lines', name='30-39')
fig <- fig %>% add_trace(y = AllData$Sub49Pond, x=AllData$Data, type='scatter', mode = 'lines', name='40-49')
fig <- fig %>% add_trace(y = AllData$Sub59Pond, x=AllData$Data, type='scatter', mode = 'lines', name='50-59')
fig <- fig %>% add_trace(y = AllData$Sub69Pond, x=AllData$Data, type='scatter', mode = 'lines', name='60-69')
fig <- fig %>% add_trace(y = AllData$Sub79Pond, x=AllData$Data, type='scatter', mode = 'lines', name='70-79')
fig <- fig %>% add_trace(y = AllData$Sub89Pond, x=AllData$Data, type='scatter', mode = 'lines', name='80-89')
fig <- fig %>% add_trace(y = AllData$Sub90Pond, x=AllData$Data, type='scatter', mode = 'lines', name='90+')

fig

```


Row
-------------------------------------
### Rates of real cases
The percent of detection to obtain the real cases are based on the prevalence. We apply if for the different rounbds, being the Round I to III almost the same

```{r Cases(4), echo=FALSE}


fig <- plot_ly(type="bar", 
               x = AllData$Data,
               y = AllData$taxaPond,
               name = 'observations',
               text = paste("new cases"))
fig <- fig %>% add_trace(y = AllData$taxaSub09Pond, x=AllData$Data, type='scatter', mode = 'lines', name='0-9')
fig <- fig %>% add_trace(y = AllData$taxaSub19Pond, x=AllData$Data, type='scatter', mode = 'lines', name='10-19')
fig <- fig %>% add_trace(y = AllData$taxaSub29Pond, x=AllData$Data, type='scatter', mode = 'lines', name='20-29')
fig <- fig %>% add_trace(y = AllData$taxaSub39Pond, x=AllData$Data, type='scatter', mode = 'lines', name='30-39')
fig <- fig %>% add_trace(y = AllData$taxaSub49Pond, x=AllData$Data, type='scatter', mode = 'lines', name='40-49')
fig <- fig %>% add_trace(y = AllData$taxaSub59Pond, x=AllData$Data, type='scatter', mode = 'lines', name='50-59')
fig <- fig %>% add_trace(y = AllData$taxaSub69Pond, x=AllData$Data, type='scatter', mode = 'lines', name='60-69')
fig <- fig %>% add_trace(y = AllData$taxaSub79Pond, x=AllData$Data, type='scatter', mode = 'lines', name='70-79')
fig <- fig %>% add_trace(y = AllData$taxaSub89Pond, x=AllData$Data, type='scatter', mode = 'lines', name='80-89')
fig <- fig %>% add_trace(y = AllData$taxaSub90Pond, x=AllData$Data, type='scatter', mode = 'lines', name='90+')

fig

```

Row
-------------------------------------
### Rates of real cases smoth
Evolution of the rates of real cases by age smooth by loess

```{r CasesRealSmooth, echo=FALSE}


fig <- plot_ly(type="bar", 
               x = AllData$Data,
               y = AllData$taxaPond,
               name = 'observations',
               text = paste("new cases"))

annotation1 <- list(yref = 'y', xref = "x", y = 300, x = "2020-03-14", text = "Estat d'alarma")
annotation2 <- list(yref = 'y', xref = "x", y = 200, x = "2020-06-24", text = "Sant Joan")
annotation3 <- list(yref = 'y', xref = "x", y = 1500, x = "2020-09-15", text = "Inici escoles")

# http://r-statistics.co/Loess-Regression-With-R.html
loessMod10 <- loess(AllData$taxaSub09Pond~AllData$ID, span=0.10)
fig <- fig %>% add_trace(y = predict(loessMod10), x=AllData$Data, type='scatter', mode = 'lines', name='0-9') #%>% layout(annotations= list(annotation1,annotation2,annotation3))

loessMod10 <- loess(AllData$taxaSub19Pond~AllData$ID, span=0.10)
fig <- fig %>% add_trace(y = predict(loessMod10), x=AllData$Data, type='scatter', mode = 'lines', name='10-19')

loessMod10 <- loess(AllData$taxaSub29Pond~AllData$ID, span=0.10)
fig <- fig %>% add_trace(y = predict(loessMod10), x=AllData$Data, type='scatter', mode = 'lines', name='20-29')

loessMod10 <- loess(AllData$taxaSub39Pond~AllData$ID, span=0.10)
fig <- fig %>% add_trace(y = predict(loessMod10), x=AllData$Data, type='scatter', mode = 'lines', name='30-39')

loessMod10 <- loess(AllData$taxaSub49Pond~AllData$ID, span=0.10)
fig <- fig %>% add_trace(y = predict(loessMod10), x=AllData$Data, type='scatter', mode = 'lines', name='40-49')

loessMod10 <- loess(AllData$taxaSub59Pond~AllData$ID, span=0.10)
fig <- fig %>% add_trace(y = predict(loessMod10), x=AllData$Data, type='scatter', mode = 'lines', name='50-59')

loessMod10 <- loess(AllData$taxaSub69Pond~AllData$ID, span=0.10)
fig <- fig %>% add_trace(y = predict(loessMod10), x=AllData$Data, type='scatter', mode = 'lines', name='60-69')

loessMod10 <- loess(AllData$taxaSub79Pond~AllData$ID, span=0.10)
fig <- fig %>% add_trace(y = predict(loessMod10), x=AllData$Data, type='scatter', mode = 'lines', name='70-79')

loessMod10 <- loess(AllData$taxaSub89Pond~AllData$ID, span=0.10)
fig <- fig %>% add_trace(y = predict(loessMod10), x=AllData$Data, type='scatter', mode = 'lines', name='80-89')

loessMod10 <- loess(AllData$taxaSub90Pond~AllData$ID, span=0.10)
fig <- fig %>% add_trace(y = predict(loessMod10), x=AllData$Data, type='scatter', mode = 'lines', name='90+')


fig

```

Granger Tests {data-icon="fa-hashtag"}
===============================================================

The Granger causality test is a statistical hypothesis test for determining whether one time series is useful in forecasting another. See https://en.wikipedia.org/wiki/Granger_causality

<!-- ### Augmented Dickey-Fuller Tes {data-padding=500} -->

<!-- ```{r grangerADFTests, echo=FALSE} -->

<!-- # https://www.rdocumentation.org/packages/aTSA/versions/3.1.2/topics/adf.test -->
<!-- dependent=AllDataGRanger$Sub49 -->
<!-- independent=AllDataGRanger$Sub19 -->

<!-- # Augmented Dickey-Fuller Test to thes if the timeseries is stationary -->
<!-- # https://www.real-statistics.com/time-series-analysis/autoregressive-processes/augmented-dickey-fuller-test/ -->
<!-- ADFTest <- adf.test(AllDataGRanger$Sub9) -->
<!-- ADFTest -->
<!-- ADFTest <- adf.test(AllDataGRanger$Sub19) -->
<!-- ADFTest -->
<!-- ADFTest <- adf.test(AllDataGRanger$Sub49) -->
<!-- ADFTest -->
<!-- ADFTest <- adf.test(AllDataGRanger$Sub39) -->
<!-- ADFTest -->
<!-- ``` -->


<!-- ### kpss tests {data-padding=50} -->

<!-- ```{r grangerKKPSTests, echo=FALSE} -->

<!-- nLags=10 #Not ready to change automatically the number of falgs to do the analysis -->

<!-- # https://www.statisticshowto.com/kpss-test/ -->
<!-- # The null hypothesis for the test is that the data is stationary. -->
<!-- # The alternate hypothesis for the test is that the data is not stationary. -->
<!-- kpssTest <- kpss.test(AllDataGRanger$Sub9, null = "T", lshort = FALSE) -->
<!-- kpssTest -->
<!-- kpssTest <- kpss.test(AllDataGRanger$Sub19, null = "T", lshort = FALSE) -->
<!-- kpssTest -->
<!-- kpssTest <- kpss.test(AllDataGRanger$Sub49, null = "T", lshort = FALSE) -->
<!-- kpssTest -->
<!-- kpssTest <- kpss.test(AllDataGRanger$Sub39, null = "T", lshort = FALSE) -->
<!-- kpssTest -->
<!-- ``` -->

Row {.tabset .tabset-fade}
-----------------------------------------------------------------------
### Phillips-Ouliaris Cointegration Test {data-padding=50}

```{r grangerCointegrationTests, echo=FALSE}

# https://bookdown.org/ccolonescu/RPoE4/time-series-nonstationarity.html#cointegration
# http://math.furman.edu/~dcs/courses/math47/R/library/tseries/html/po.test.html

nLags=10 #Not ready to change automatically the number of falgs to do the analysis

# https://www.statisticshowto.com/kpss-test/
# The null hypothesis for the test is that the data is stationary.
# The alternate hypothesis for the test is that the data is not stationary.
bfx <- as.matrix(cbind(AllDataGRanger$Sub49,AllDataGRanger$Sub19), demean=FALSE)
po.test(bfx)

bfx <- as.matrix(cbind(AllDataGRanger$Sub39,AllDataGRanger$Sub09), demean=FALSE)
po.test(bfx)
```

Row {.tabset .tabset-fade}
-----------------------------------------------------------------------
### Detected cases

```{r grangerObs, echo=FALSE}

# https://rdrr.io/cran/lmtest/man/grangertest.html
# https://www.projectguru.in/granger-causality-test-stata/
# https://www.statisticshowto.com/granger-causality/

Grangers=NULL

Grangers <- data.frame(
  Lag=c("Lag 1", "Lag 2", "Lag 3", "Lag 4", "Lag 5", "Lag 6", "Lag 7", "Lag 8", "Lag 9", "Lag 10"),
  gr49by19=c(0,0,0,0,0,0,0,0,0,0),
  gr49by09=c(0,0,0,0,0,0,0,0,0,0),
  gr39by19=c(0,0,0,0,0,0,0,0,0,0),
  gr39by09=c(0,0,0,0,0,0,0,0,0,0),

  gr19by49=c(0,0,0,0,0,0,0,0,0,0),
  gr09by49=c(0,0,0,0,0,0,0,0,0,0),
  gr19by39=c(0,0,0,0,0,0,0,0,0,0),
  gr09by39=c(0,0,0,0,0,0,0,0,0,0)
  )


# # ADF test for AR(1) process
# x <- arima.sim(list(order = c(1,0,0),ar = 0.2),n = 100)
# adf.test(x)
# # ADF test for co2 data
# adf.test(co2)
# 
# 
# write.csv(AllDataGRanger$Sub49, file="Adults49.csv")
# write.csv(AllDataGRanger$MenorBsDat, file="Menors19.csv")

dependent=AllDataGRanger$taxaSub49
independent=AllDataGRanger$taxaSub19


i=1;
while (i<=nLags)
{
  GRtest<-grangertest(dependent~independent, order=i)
  Grangers$gr49by19[i]<-GRtest$`Pr(>F)`[2]
  i=i+1
}

independent=AllDataGRanger$taxaSub09

i=1;
while (i<=nLags)
{
  GRtest<-grangertest(dependent~independent, order=i)
  Grangers$gr49by09[i]<-GRtest$`Pr(>F)`[2]
  i=i+1
}

dependent=AllDataGRanger$taxaSub39
independent=AllDataGRanger$taxaSub19

i=1;
while (i<=nLags)
{
  GRtest<-grangertest(dependent~independent, order=i)
  Grangers$gr39by19[i]<-GRtest$`Pr(>F)`[2]
  i=i+1
}

independent=AllDataGRanger$taxaSub09

i=1;
while (i<=nLags)
{
  GRtest<-grangertest(dependent~independent, order=i)
  Grangers$gr39by09[i]<-GRtest$`Pr(>F)`[2]
  i=i+1
}

##### Change the order


independent=AllDataGRanger$taxaSub49
dependent=AllDataGRanger$taxaSub19

i=1;
while (i<=nLags)
{
  GRtest<-grangertest(dependent~independent, order=i)
  Grangers$gr19by49[i]<-GRtest$`Pr(>F)`[2]
  i=i+1
}

independent=AllDataGRanger$taxaSub39

i=1;
while (i<=nLags)
{
  GRtest<-grangertest(dependent~independent, order=i)
  Grangers$gr19by39[i]<-GRtest$`Pr(>F)`[2]
  i=i+1
}

independent=AllDataGRanger$taxaSub49
dependent=AllDataGRanger$taxaSub09

i=1;
while (i<=nLags)
{
  GRtest<-grangertest(dependent~independent, order=i)
  Grangers$gr09by49[i]<-GRtest$`Pr(>F)`[2]
  i=i+1
}

independent=AllDataGRanger$taxaSub39

i=1;
while (i<=nLags)
{
  GRtest<-grangertest(dependent~independent, order=i)
  Grangers$gr09by39[i]<-GRtest$`Pr(>F)`[2]
  i=i+1
}

# rownames(Grangers) <- c("Lag 1", "Lag 2", "Lag 3", "Lag 4", "Lag 5", "Lag 6", "Lag 7", "Lag 8", "Lag 9", "Lag 10")
# colnames(Grangers) <- c("Lags","gr49by19", "gr49by09", "gr39by19", "gr39by09", "gr19by49", "gr09by49", "gr19by39", "gr09by39")

# What you need

  # mutate(Grangers$gr49by19 = cell_spec(Grangers$gr49by19, color = ifelse(Grangers$gr49by19 > 0.05, "green","red")))
  # Grangers$gr49by09 = cell_spec(Grangers$gr49by09, color = ifelse(Grangers$gr49by09 > 0.05, "green","red"))
  # Grangers$gr39by19 = cell_spec(Grangers$gr39by19, color = ifelse(Grangers$gr39by19 > 0.05, "green","red"))
  # Grangers$gr39by09 = cell_spec(Grangers$gr39by09, color = ifelse(Grangers$gr39by09 > 0.05, "green","red"))
  # Grangers$gr19by49 = cell_spec(Grangers$gr19by49, color = ifelse(Grangers$gr19by49 > 0.05, "green","red"))
  # Grangers$gr09by49 = cell_spec(Grangers$gr09by49, color = ifelse(Grangers$gr09by49 > 0.05, "green","red"))
  # Grangers$gr19by39 = cell_spec(Grangers$gr19by39, color = ifelse(Grangers$gr19by39 > 0.05, "green","red"))
  # Grangers$gr09by39 = cell_spec(Grangers$gr09by39, color = ifelse(Grangers$gr09by39 > 0.05, "green","red"))
  

knitr::kable(Grangers, digits=3)

# library(kableExtra)
# 
# # colnames(Grangers)
# # [1] "Lag"      "gr49by19" "gr49by09" "gr39by19" "gr39by09" "gr19by49" "gr09by49" "gr19by39" "gr09by39"
# 
# 
# head(iris[c("Species","Sepal.Length")]) %>%
#   mutate(
#     Sepal.Length = cell_spec(Sepal.Length, color = ifelse(Sepal.Length > 5, "green","red"))) %>%
#   kable(escape = FALSE) %>%
#   kable_styling(position = "left", full_width = FALSE) %>%
#     column_spec(1, bold = TRUE, border_right = TRUE, color = "black", background = "lightgrey")
# 
# head(Grangers[c("Lag", "gr49by19", "gr49by09", "gr39by19", "gr39by09", "gr19by49", "gr09by49", "gr19by39", "gr09by39")]) %>%
#   mutate(gr49by19 = cell_spec(gr49by19, round(gr49by19,3), color = ifelse(gr49by19 > 0.05, "green","red"))) %>%
#   # mutate(gr49by09 = cell_spec(gr49by09, color = ifelse(gr49by09 > 0.05, "green","red"))) %>%
#   # mutate(gr39by19 = cell_spec(gr39by19, color = ifelse(gr39by19 > 0.05, "green","red"))) %>%
#   # mutate(gr39by09 = cell_spec(gr39by09, color = ifelse(gr39by09 > 0.05, "green","red"))) %>%
#   # mutate(gr19by49 = cell_spec(gr19by49, color = ifelse(gr19by49 > 0.05, "green","red"))) %>%
#   # mutate(gr09by49 = cell_spec(gr09by49, color = ifelse(gr09by49 > 0.05, "green","red"))) %>%
#   # mutate(gr19by39 = cell_spec(gr19by39, color = ifelse(gr19by39 > 0.05, "green","red"))) %>%
#   # mutate(gr09by39 = cell_spec(gr09by39, color = ifelse(gr09by39 > 0.05, "green","red"))) %>%
#   kable(escape = FALSE, digits=5) %>%
#   kable_styling(position = "left", full_width = FALSE) %>%
#     column_spec(1, bold = TRUE, border_right = TRUE, color = "black", background = "lightgrey")


```
### Real cases

```{r grangerReal, echo=FALSE}

Grangers=NULL

Grangers <- data.frame(
  Lag=c("Lag 1", "Lag 2", "Lag 3", "Lag 4", "Lag 5", "Lag 6", "Lag 7", "Lag 8", "Lag 9", "Lag 10"),
  gr49by19=c(0,0,0,0,0,0,0,0,0,0),
  gr49by09=c(0,0,0,0,0,0,0,0,0,0),
  gr39by19=c(0,0,0,0,0,0,0,0,0,0),
  gr39by09=c(0,0,0,0,0,0,0,0,0,0),

  gr19by49=c(0,0,0,0,0,0,0,0,0,0),
  gr09by49=c(0,0,0,0,0,0,0,0,0,0),
  gr19by39=c(0,0,0,0,0,0,0,0,0,0),
  gr09by39=c(0,0,0,0,0,0,0,0,0,0)
  )

dependent=AllDataGRanger$Sub49Pond
independent=AllDataGRanger$Sub19Pond

i=1;
while (i<=nLags)
{
  GRtest<-grangertest(dependent~independent, order=i)
  Grangers$gr49by19[i]<-GRtest$`Pr(>F)`[2]
  i=i+1
}

independent=AllDataGRanger$Sub09Pond

i=1;
while (i<=nLags)
{
  GRtest<-grangertest(dependent~independent, order=i)
  Grangers$gr49by09[i]<-GRtest$`Pr(>F)`[2]
  i=i+1
}

dependent=AllDataGRanger$Sub39Pond
independent=AllDataGRanger$Sub19Pond

i=1;
while (i<=nLags)
{
  GRtest<-grangertest(dependent~independent, order=i)
  Grangers$gr39by19[i]<-GRtest$`Pr(>F)`[2]
  i=i+1
}

independent=AllDataGRanger$Sub09Pond

i=1;
while (i<=nLags)
{
  GRtest<-grangertest(dependent~independent, order=i)
  Grangers$gr39by09[i]<-GRtest$`Pr(>F)`[2]
  i=i+1
}

##### Change the order


independent=AllDataGRanger$Sub49Pond
dependent=AllDataGRanger$Sub19Pond

i=1;
while (i<=nLags)
{
  GRtest<-grangertest(dependent~independent, order=i)
  Grangers$gr19by49[i]<-GRtest$`Pr(>F)`[2]
  i=i+1
}

independent=AllDataGRanger$Sub39Pond

i=1;
while (i<=nLags)
{
  GRtest<-grangertest(dependent~independent, order=i)
  Grangers$gr19by39[i]<-GRtest$`Pr(>F)`[2]
  i=i+1
}

independent=AllDataGRanger$Sub49Pond
dependent=AllDataGRanger$Sub09Pond

i=1;
while (i<=nLags)
{
  GRtest<-grangertest(dependent~independent, order=i)
  Grangers$gr09by49[i]<-GRtest$`Pr(>F)`[2]
  i=i+1
}

independent=AllDataGRanger$Sub39Pond

i=1;
while (i<=nLags)
{
  GRtest<-grangertest(dependent~independent, order=i)
  Grangers$gr09by39[i]<-GRtest$`Pr(>F)`[2]
  i=i+1
}

# rownames(Grangers) <- c("Lag 1", "Lag 2", "Lag 3", "Lag 4", "Lag 5", "Lag 6", "Lag 7", "Lag 8", "Lag 9", "Lag 10")

knitr::kable(Grangers, digits=3)
```

### Real cases (taxes)
Notice that no modification due to the use of the taxes (modifying both series the same), we add this just for validation purposes.

```{r grangerRealTaxes, echo=FALSE}

Grangers=NULL

Grangers <- data.frame(
  Lag=c("Lag 1", "Lag 2", "Lag 3", "Lag 4", "Lag 5", "Lag 6", "Lag 7", "Lag 8", "Lag 9", "Lag 10"),
  gr49by19=c(0,0,0,0,0,0,0,0,0,0),
  gr49by09=c(0,0,0,0,0,0,0,0,0,0),
  gr39by19=c(0,0,0,0,0,0,0,0,0,0),
  gr39by09=c(0,0,0,0,0,0,0,0,0,0),

  gr19by49=c(0,0,0,0,0,0,0,0,0,0),
  gr09by49=c(0,0,0,0,0,0,0,0,0,0),
  gr19by39=c(0,0,0,0,0,0,0,0,0,0),
  gr09by39=c(0,0,0,0,0,0,0,0,0,0)
  )

dependent=AllDataGRanger$taxaSub49Pond
independent=AllDataGRanger$taxaSub19Pond

i=1;
while (i<=nLags)
{
  GRtest<-grangertest(dependent~independent, order=i)
  Grangers$gr49by19[i]<-GRtest$`Pr(>F)`[2]
  i=i+1
}

independent=AllDataGRanger$taxaSub09Pond

i=1;
while (i<=nLags)
{
  GRtest<-grangertest(dependent~independent, order=i)
  Grangers$gr49by09[i]<-GRtest$`Pr(>F)`[2]
  i=i+1
}

dependent=AllDataGRanger$taxaSub39Pond
independent=AllDataGRanger$taxaSub19Pond

i=1;
while (i<=nLags)
{
  GRtest<-grangertest(dependent~independent, order=i)
  Grangers$gr39by19[i]<-GRtest$`Pr(>F)`[2]
  i=i+1
}

independent=AllDataGRanger$taxaSub09Pond

i=1;
while (i<=nLags)
{
  GRtest<-grangertest(dependent~independent, order=i)
  Grangers$gr39by09[i]<-GRtest$`Pr(>F)`[2]
  i=i+1
}

##### Change the order


independent=AllDataGRanger$taxaSub49Pond
dependent=AllDataGRanger$taxaSub19Pond

i=1;
while (i<=nLags)
{
  GRtest<-grangertest(dependent~independent, order=i)
  Grangers$gr19by49[i]<-GRtest$`Pr(>F)`[2]
  i=i+1
}

independent=AllDataGRanger$taxaSub39Pond

i=1;
while (i<=nLags)
{
  GRtest<-grangertest(dependent~independent, order=i)
  Grangers$gr19by39[i]<-GRtest$`Pr(>F)`[2]
  i=i+1
}

independent=AllDataGRanger$taxaSub49Pond
dependent=AllDataGRanger$taxaSub09Pond

i=1;
while (i<=nLags)
{
  GRtest<-grangertest(dependent~independent, order=i)
  Grangers$gr09by49[i]<-GRtest$`Pr(>F)`[2]
  i=i+1
}

independent=AllDataGRanger$taxaSub39Pond

i=1;
while (i<=nLags)
{
  GRtest<-grangertest(dependent~independent, order=i)
  Grangers$gr09by39[i]<-GRtest$`Pr(>F)`[2]
  i=i+1
}

# rownames(Grangers) <- c("Lag 1", "Lag 2", "Lag 3", "Lag 4", "Lag 5", "Lag 6", "Lag 7", "Lag 8", "Lag 9", "Lag 10")

knitr::kable(Grangers, digits=3)
```


Chow test {data-icon="fa-hashtag"}
===============================================================

Row {.tabset .tabset-fade}
-----------------------------------------------------------------------
### Description

The Chow test, proposed by econometrician Gregory Chow in 1960, is a test of whether the true coefficients in two linear regressions on different data sets are equal. In econometrics, it is most commonly used in time series analysis to test for the presence of a structural break at a period which can be assumed to be known a priori (for instance, a major historical event such as a war). In program evaluation, the Chow test is often used to determine whether the independent variables have different impacts on different subgroups of the population. Source: https://en.wikipedia.org/wiki/Chow_test

### Catalonia

We plot all the p.values for the Chow test to find the periods where the trends between the 10-19 serie and the 40-49 serie differs, when the p.value is over the critical value of 0.05 implies that the series moves along.

```{r chow_CAT, echo=FALSE}
library(strucchange)

#Create the cointegration matrix with all the series but the 40-49.

dependent <- AllDataGRanger$taxaSub49
independent <- AllDataGRanger$taxaSub19

lastDay=length(AllDataGRanger$taxaSub19)

dia <- 10

chow.results <- data.frame("Day", "p.value", "Date")

while(dia<lastDay-10)
{
  chow.test <- sctest(dependent ~ independent, data = AllDataGRanger,  type = "Chow", point = dia)
  
  new_row <- c(as.integer(dia),as.numeric(chow.test$p.value),as.Date(AllDataGRanger$Data[dia],"%m/%d/%y"))
  
  chow.results <- rbind(chow.results,new_row)
  
  dia<-dia+1
}


fig <- plot_ly(type="bar", 
               x = chow.results$X.Date.,
               y = chow.results$X.p.value.,
               name = 'p.values',
               text = paste("Days"))

fig <- fig %>% add_trace(y = 0.05, x=chow.results$X.Date., type='scatter', mode = 'lines', name='p.value=0.05')


fig
```

### Opening schools day

```{r, echo=FALSE}

OberturaEscolesIndex <- which(grepl(DiaOberturaEscoles, AllDataGRanger$Data))

dia <- OberturaEscolesIndex #Obertuira escoles 177

chow.test <- sctest(dependent ~ independent, data = AllDataGRanger,  type = "Chow", point = dia)

articles <- paste("Day:",dia)
articles <- paste(articles, "->")
articles <- paste(articles, chow.test$p.value)
valueBox(articles, icon = "fa-pencil", color = ifelse(chow.test$p.value < 0.05, "warning", "primary"))

```

Data
===============================================================

Row {.tabset .tabset-fade}
-----------------------------------------------------------------------
### Data

The dataset needed to do this analysis. Accesed thorugt Open Data.

Data: Date
casosPositiusData: All new cases detected
PCRsData: All tests done
Sub9 to	Sub90: All new cases by age
PCRsSub9 to PCRsAvisData: All PCRs by age
casosSub15 to casosAvis: All new cases by other range age
totalPond: All real cases (prevalence)
Sub09Pond to Sub90Pond: Real cases by age (prevalence)
Taxa: All cases rate
taxaSub09 to taxaSub90	: Rates by age
taxaPond: All real cases rate (prevalence)
taxaSub09 to taxaSub90Pond: All real cases rate by age (prevalence)
percPos	percPosSub15 to percPosSub00: Percent of positivity by age



```{r dataDownload, echo=FALSE}

# download_this(
#  AllData,
#  output_name = NULL,
#  output_extension = c(".csv", ".xlsx", ".rds"),
#  button_label = "Download All data",
#  button_type = c("default", "primary", "success", "info", "warning", "danger"),
#  icon = "fa fa-save",
#  self_contained = FALSE,
#  csv2 = TRUE,
#  ggsave_args = list()
# )
# 
# download_this(
#  AllDataGRanger,
#  output_name = NULL,
#  output_extension = c(".csv", ".xlsx", ".rds"),
#  button_label = "Download Analysis data",
#  button_type = c("default", "primary", "success", "info", "warning", "danger"),
#  icon = "fa fa-save",
#  self_contained = FALSE,
#  csv2 = TRUE,
#  ggsave_args = list()
# )

```
